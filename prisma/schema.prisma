generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ServiceType {
  id                   String                @id @default(uuid())
  name                 String                @unique
  displayName          String                @map("display_name")
  formSchema           String                @map("form_schema")
  active               Boolean               @default(true)
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  buyerServiceConfigs  BuyerServiceConfig[]
  buyerServiceZipCodes BuyerServiceZipCode[]
  leads                Lead[]

  @@map("service_types")
}

model Buyer {
  id                      String                @id @default(uuid())
  name                    String
  displayName             String?               @map("display_name")
  type                    String                @default("CONTRACTOR") // NETWORK or CONTRACTOR
  apiUrl                  String                @map("api_url")
  authConfig              String?               @map("auth_config")
  webhookSecret           String?               @map("webhook_secret")
  authType                String?               @map("auth_type")
  pingTimeout             Int                   @default(30) @map("ping_timeout")
  postTimeout             Int                   @default(60) @map("post_timeout")
  active                  Boolean               @default(true)
  complianceFieldMappings String?               @map("compliance_field_mappings")
  responseMappingConfig   String?               @map("response_mapping_config")
  contactName             String?               @map("contact_name")
  contactEmail            String?               @map("contact_email")
  contactPhone            String?               @map("contact_phone")
  businessEmail           String?               @map("business_email")
  businessPhone           String?               @map("business_phone")
  additionalEmails        String?               @map("additional_emails")
  additionalPhones        String?               @map("additional_phones")
  additionalContacts      String?               @map("additional_contacts")
  notes                   String?               @db.Text // Internal notes: docs links, tagId info, integration notes

  // Contractor delivery settings (supports lead-flow.mmd diagram)
  deliveryMode            String                @default("EXCLUSIVE") @map("delivery_mode") // EXCLUSIVE or SHARED
  maxSharedLeads          Int                   @default(3) @map("max_shared_leads") // If SHARED, how many contractors get lead
  fixedLeadPrice          Decimal?              @map("fixed_lead_price") @db.Decimal(10, 2) // For FIXED pricing model
  pricingModel            String                @default("AUCTION") @map("pricing_model") // FIXED, AUCTION, or HYBRID

  // Notification channel preferences for contractors
  notifyEmail             Boolean               @default(true) @map("notify_email")
  notifyWebhook           Boolean               @default(false) @map("notify_webhook")
  notifyDashboard         Boolean               @default(true) @map("notify_dashboard")

  createdAt               DateTime              @default(now()) @map("created_at")
  updatedAt               DateTime              @updatedAt @map("updated_at")
  serviceConfigs          BuyerServiceConfig[]
  serviceZipCodes         BuyerServiceZipCode[]
  wonLeads                Lead[]
  transactions            Transaction[]

  @@index([type])
  @@index([pricingModel])
  @@map("buyers")
}

model BuyerServiceConfig {
  id                  String      @id @default(uuid())
  buyerId             String      @map("buyer_id")
  serviceTypeId       String      @map("service_type_id")
  pingTemplate        String      @map("ping_template")
  postTemplate        String      @map("post_template")
  fieldMappings       String      @map("field_mappings")
  requiresTrustedForm Boolean     @default(false) @map("requires_trustedform")
  requiresJornaya     Boolean     @default(false) @map("requires_jornaya")
  complianceConfig    String?     @map("compliance_config")
  minBid              Decimal     @default(0.00) @map("min_bid")
  maxBid              Decimal     @default(999.99) @map("max_bid")
  active              Boolean     @default(true)
  createdAt           DateTime    @default(now()) @map("created_at")
  lastZipCodeUpdate   DateTime?   @map("last_zip_code_update")
  zipCodeSource       String?     @map("zip_code_source") // Original filename for audit trail
  buyer               Buyer       @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  serviceType         ServiceType @relation(fields: [serviceTypeId], references: [id], onDelete: Cascade)

  @@unique([buyerId, serviceTypeId])
  @@map("buyer_service_configs")
}

model Lead {
  id                 String               @id @default(uuid())
  serviceTypeId      String               @map("service_type_id")
  formData           String               @map("form_data")
  zipCode            String               @map("zip_code")
  ownsHome           Boolean              @map("owns_home")
  timeframe          String
  status             String               @default("PENDING") // PENDING, PROCESSING, AUCTIONED, SOLD, REJECTED, EXPIRED, DELIVERY_FAILED, SCRUBBED, DUPLICATE
  winningBuyerId     String?              @map("winning_buyer_id")
  winningBid         Decimal?             @map("winning_bid")
  trustedFormCertUrl String?              @map("trusted_form_cert_url")
  trustedFormCertId  String?              @map("trusted_form_cert_id")
  jornayaLeadId      String?              @map("jornaya_lead_id")
  complianceData     String?              @map("compliance_data")
  leadQualityScore   Int?                 @map("lead_quality_score")
  // Accounting fields
  disposition        String               @default("NEW") @map("disposition") // NEW, DELIVERED, RETURNED, DISPUTED, CREDITED, WRITTEN_OFF
  creditAmount       Decimal?             @map("credit_amount") @db.Decimal(10, 2)
  creditIssuedAt     DateTime?            @map("credit_issued_at")
  creditIssuedById   String?              @map("credit_issued_by_id")
  // Timestamps
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  // Relations
  complianceAudits       ComplianceAuditLog[]
  serviceType            ServiceType          @relation(fields: [serviceTypeId], references: [id])
  winningBuyer           Buyer?               @relation(fields: [winningBuyerId], references: [id])
  transactions           Transaction[]
  statusHistory          LeadStatusHistory[]
  affiliateCommissions   AffiliateCommission[]

  @@index([status])
  @@index([zipCode])
  @@index([createdAt])
  @@index([trustedFormCertId])
  @@index([jornayaLeadId])
  @@index([leadQualityScore])
  @@index([disposition])
  @@map("leads")
}

model Transaction {
  id                 String   @id @default(uuid())
  leadId             String   @map("lead_id")
  buyerId            String   @map("buyer_id")
  actionType         String   @map("action_type") // PING, POST, DELIVERY
  payload            String
  response           String?
  status             String   // SUCCESS, FAILED, TIMEOUT, REJECTED
  bidAmount          Decimal? @map("bid_amount") @db.Decimal(10, 2)
  responseTime       Int?     @map("response_time")
  errorMessage       String?  @map("error_message")
  complianceIncluded Boolean  @default(false) @map("compliance_included")
  trustedFormPresent Boolean  @default(false) @map("trusted_form_present")
  jornayaPresent     Boolean  @default(false) @map("jornaya_present")

  // Winner/Loser tracking for analytics (supports lead-flow.mmd diagram)
  isWinner           Boolean? @map("is_winner")
  lostReason         String?  @map("lost_reason") // OUTBID, TIMEOUT, NO_BID, BELOW_MIN_BID, POST_REJECTED, DUPLICATE_LEAD, OUTSIDE_HOURS, CAP_REACHED, CASCADE_EXHAUSTED, NOT_SELECTED, EXCLUSIVE_TAKEN, LOWER_PRIORITY
  winningBidAmount   Decimal? @map("winning_bid_amount") @db.Decimal(10, 2) // For analytics: what the winner bid

  // Cascade tracking for fallback delivery
  cascadePosition    Int?     @map("cascade_position") // 1 = first attempt, 2 = second, etc.

  // Contractor delivery tracking
  deliveryMethod     String?  @map("delivery_method") // EMAIL, WEBHOOK, DASHBOARD, SMS

  createdAt          DateTime @default(now()) @map("created_at")
  buyer              Buyer    @relation(fields: [buyerId], references: [id])
  lead               Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([actionType])
  @@index([status])
  @@index([createdAt])
  @@index([complianceIncluded])
  @@index([isWinner])
  @@index([lostReason])
  @@map("transactions")
}

model ComplianceAuditLog {
  id        String   @id @default(uuid())
  leadId    String   @map("lead_id")
  eventType String   @map("event_type")
  eventData String   @map("event_data")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([eventType])
  @@index([createdAt])
  @@map("compliance_audit_log")
}

model BuyerServiceZipCode {
  id             String      @id @default(uuid())
  buyerId        String      @map("buyer_id")
  serviceTypeId  String      @map("service_type_id")
  zipCode        String      @map("zip_code")
  active         Boolean     @default(true)
  priority       Int         @default(100)
  maxLeadsPerDay Int?        @map("max_leads_per_day")
  minBid         Decimal?    @map("min_bid")
  maxBid         Decimal?    @map("max_bid")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")
  buyer          Buyer       @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  serviceType    ServiceType @relation(fields: [serviceTypeId], references: [id], onDelete: Cascade)

  @@unique([buyerId, serviceTypeId, zipCode])
  @@index([buyerId, serviceTypeId])
  @@index([serviceTypeId, zipCode])
  @@index([zipCode])
  @@index([active])
  @@map("buyer_service_zip_codes")
}

model ZipCodeMetadata {
  zipCode   String   @id @map("zip_code")
  city      String
  state     String
  county    String?
  latitude  Float?
  longitude Float?
  timezone  String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([state])
  @@index([city, state])
  @@map("zip_code_metadata")
}

// ============================================
// ADMIN USER & LEAD ACCOUNTING MODELS
// ============================================

model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  role      String   @default("ADMIN") // SUPER_ADMIN, ADMIN, SUPPORT
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  statusChanges LeadStatusHistory[]

  @@map("admin_users")
}

model LeadStatusHistory {
  id             String   @id @default(uuid())
  leadId         String   @map("lead_id")
  adminUserId    String?  @map("admin_user_id") // null for system-triggered changes
  oldStatus      String?  @map("old_status")
  newStatus      String   @map("new_status")
  oldDisposition String?  @map("old_disposition")
  newDisposition String?  @map("new_disposition")
  reason         String?  // Required for admin changes
  creditAmount   Decimal? @map("credit_amount") @db.Decimal(10, 2)
  changeSource   String   @default("SYSTEM") @map("change_source") // SYSTEM, ADMIN, WEBHOOK
  ipAddress      String?  @map("ip_address")
  createdAt      DateTime @default(now()) @map("created_at")

  lead      Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
  adminUser AdminUser? @relation(fields: [adminUserId], references: [id])

  @@index([leadId])
  @@index([adminUserId])
  @@index([newStatus])
  @@index([createdAt])
  @@map("lead_status_history")
}

// ============================================
// AFFILIATE SYSTEM MODELS
// ============================================

enum AffiliateStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum WithdrawalStatus {
  REQUESTED
  PROCESSING
  COMPLETED
  FAILED
}

model Affiliate {
  id              String          @id @default(uuid())
  email           String          @unique
  passwordHash    String          @map("password_hash")
  firstName       String          @map("first_name")
  lastName        String          @map("last_name")
  companyName     String?         @map("company_name")
  phone           String?
  commissionRate  Decimal         @default(0.10) @map("commission_rate") @db.Decimal(5, 4)
  status          AffiliateStatus @default(PENDING)
  emailVerified   Boolean         @default(false) @map("email_verified")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  links       AffiliateLink[]
  commissions AffiliateCommission[]
  withdrawals AffiliateWithdrawal[]

  @@index([status])
  @@index([email])
  @@map("affiliates")
}

model AffiliateLink {
  id          String    @id @default(uuid())
  affiliateId String    @map("affiliate_id")
  code        String    @unique
  targetPath  String    @map("target_path") // e.g., "/windows", "/roofing"
  name        String?   // e.g., "Facebook Campaign Jan"
  clicks      Int       @default(0)
  conversions Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([code])
  @@index([isActive])
  @@map("affiliate_links")
}

model AffiliateCommission {
  id          String           @id @default(uuid())
  affiliateId String           @map("affiliate_id")
  leadId      String           @map("lead_id")
  amount      Decimal          @db.Decimal(10, 2)
  rate        Decimal          @db.Decimal(5, 4) // Rate at time of creation
  status      CommissionStatus @default(PENDING)
  approvedAt  DateTime?        @map("approved_at")
  paidAt      DateTime?        @map("paid_at")
  rejectedAt  DateTime?        @map("rejected_at")
  rejectReason String?         @map("reject_reason")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([leadId])
  @@index([status])
  @@index([createdAt])
  @@map("affiliate_commissions")
}

model AffiliateWithdrawal {
  id            String           @id @default(uuid())
  affiliateId   String           @map("affiliate_id")
  amount        Decimal          @db.Decimal(10, 2)
  method        String           // "paypal", "bank_transfer"
  methodDetails String?          @map("method_details") // PayPal email, bank info (encrypted JSON)
  status        WithdrawalStatus @default(REQUESTED)
  processedAt   DateTime?        @map("processed_at")
  processedBy   String?          @map("processed_by") // Admin user ID
  notes         String?
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  affiliate Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)

  @@index([affiliateId])
  @@index([status])
  @@index([createdAt])
  @@map("affiliate_withdrawals")
}
